CREATE EXTENSION pg_tde;
SELECT pg_tde_add_global_key_provider_file('file-keyring-010', '/tmp/wal_encrypt.per');
 pg_tde_add_global_key_provider_file 
-------------------------------------
 
(1 row)

SELECT pg_tde_verify_server_key();
psql:<stdin>:1: ERROR:  principal key not configured for current database
SELECT key_name, provider_name, provider_id FROM pg_tde_server_key_info();
 key_name | provider_name | provider_id 
----------+---------------+-------------
          |               |            
(1 row)

SELECT pg_tde_create_key_using_global_key_provider('server-key', 'file-keyring-010');
 pg_tde_create_key_using_global_key_provider 
---------------------------------------------
 
(1 row)

SELECT pg_tde_set_server_key_using_global_key_provider('server-key', 'file-keyring-010');
 pg_tde_set_server_key_using_global_key_provider 
-------------------------------------------------
 
(1 row)

SELECT pg_tde_verify_server_key();
 pg_tde_verify_server_key 
--------------------------
 
(1 row)

SELECT key_name, provider_name, provider_id FROM pg_tde_server_key_info();
  key_name  |  provider_name   | provider_id 
------------+------------------+-------------
 server-key | file-keyring-010 |          -1
(1 row)

ALTER SYSTEM SET pg_tde.wal_encrypt = on;
-- server restart with wal encryption
SHOW pg_tde.wal_encrypt;
 pg_tde.wal_encrypt 
--------------------
 on
(1 row)

SELECT slot_name FROM pg_create_logical_replication_slot('tde_slot', 'test_decoding');
 slot_name 
-----------
 tde_slot
(1 row)

CREATE TABLE test_wal (id SERIAL, k INTEGER, PRIMARY KEY (id));
INSERT INTO test_wal (k) VALUES (1), (2);
ALTER SYSTEM SET pg_tde.wal_encrypt = off;
-- server restart without wal encryption
SHOW pg_tde.wal_encrypt;
 pg_tde.wal_encrypt 
--------------------
 off
(1 row)

INSERT INTO test_wal (k) VALUES (3), (4);
ALTER SYSTEM SET pg_tde.wal_encrypt = on;
-- server restart with wal encryption
SHOW pg_tde.wal_encrypt;
 pg_tde.wal_encrypt 
--------------------
 on
(1 row)

INSERT INTO test_wal (k) VALUES (5), (6);
-- server restart with still wal encryption
SHOW pg_tde.wal_encrypt;
 pg_tde.wal_encrypt 
--------------------
 on
(1 row)

INSERT INTO test_wal (k) VALUES (7), (8);
SELECT data FROM pg_logical_slot_get_changes('tde_slot', NULL, NULL, 'include-xids', '0');
                           data                            
-----------------------------------------------------------
 BEGIN
 COMMIT
 BEGIN
 table public.test_wal: INSERT: id[integer]:1 k[integer]:1
 table public.test_wal: INSERT: id[integer]:2 k[integer]:2
 COMMIT
 BEGIN
 table public.test_wal: INSERT: id[integer]:3 k[integer]:3
 table public.test_wal: INSERT: id[integer]:4 k[integer]:4
 COMMIT
 BEGIN
 table public.test_wal: INSERT: id[integer]:5 k[integer]:5
 table public.test_wal: INSERT: id[integer]:6 k[integer]:6
 COMMIT
 BEGIN
 table public.test_wal: INSERT: id[integer]:7 k[integer]:7
 table public.test_wal: INSERT: id[integer]:8 k[integer]:8
 COMMIT
(18 rows)

SELECT pg_drop_replication_slot('tde_slot');
 pg_drop_replication_slot 
--------------------------
 
(1 row)

DROP EXTENSION pg_tde;
